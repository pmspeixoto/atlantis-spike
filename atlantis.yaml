repos:
  - id: /.*/
    workflow: terraform-infracost
    post_workflow_hooks:
      - run: |
          # post_workflow_hooks are executed after the repo workflow has run.
          # This enables you to post an Infracost comment with the combined cost output
          # from all your projects. However, post_workflow_hooks are also triggered when
          # an apply occurs. In order to stop commenting on PRs twice we need to check
          # if the Infracost output directory created in our 'plan' stage exists before continuing.
          if [ ! -d "/tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM" ]; then
            exit 0
          fi

          # Choose the commenting behavior, 'new' is a good default:
          # new: Create a new cost estimate comment on every run of Atlantis for each project.
          # update: Create a single comment and update it. The "quietest" option.
          # hide-and-new: Minimize previous comments and create a new one.
          # delete-and-new: Delete previous comments and create a new one.
          infracost comment github --repo $BASE_REPO_OWNER/$BASE_REPO_NAME \
                                   --pull-request $PULL_NUM \
                                   --path /tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM/'*'-infracost.json \
                                   --github-token $GITHUB_TOKEN \
                                   --behavior new

          # remove the Infracost output directory so that `infracost comment` is not
          # triggered on an `atlantis apply`
          rm -rf /tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM
workflows:
  terraform-infracost:
    plan:
      steps:
        - env:
            name: INFRACOST_OUTPUT
            command: 'echo "/tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM/$WORKSPACE-${REPO_REL_DIR//\//-}-infracost.json"'
        - init
        - plan
        - show # this writes the plan JSON to $SHOWFILE
        # Run Infracost breakdown and save to a tempfile, namespaced by this project, PR, workspace and dir
        - run: |
            if [ ! -d "/tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM" ]; then
              mkdir -p /tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM
            fi

            infracost breakdown --path=$SHOWFILE \
                                --format=json \
                                --log-level=info \
                                --out-file=$INFRACOST_OUTPUT
